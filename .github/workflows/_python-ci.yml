name: Python CI (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version to use (reads .python-version if empty)"
        required: false
        type: string
        default: ""
      uv-version:
        description: "uv version to pin"
        required: false
        type: string
        default: "0.10.3"
      run-mypy:
        description: "Run mypy type checking"
        required: false
        type: boolean
        default: true
      working-directory:
        description: "Working directory for the project"
        required: false
        type: string
        default: "."
    secrets:
      CODECOV_TOKEN:
        required: false

jobs:
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python + uv
        uses: tstell90/platform/actions/setup-python-uv@v1
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}
          working-directory: ${{ inputs.working-directory }}

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    if: ${{ inputs.run-mypy }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python + uv
        uses: tstell90/platform/actions/setup-python-uv@v1
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}
          working-directory: ${{ inputs.working-directory }}

      - name: Mypy
        run: uv run mypy src/

  test:
    name: Test (pytest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python + uv
        uses: tstell90/platform/actions/setup-python-uv@v1
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}
          working-directory: ${{ inputs.working-directory }}

      - name: Run tests
        run: uv run pytest tests/ --junitxml=junit.xml --cov --cov-report=xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ inputs.working-directory }}/junit.xml

      - name: Upload coverage
        if: always() && secrets.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Prune uv cache
        if: always()
        run: uv cache prune --ci
